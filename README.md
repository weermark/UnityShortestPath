# UnityShortestPath

本專案為專題「以Unity模擬數位孿生城市之即時淹水災防應用」之簡化版專案、部分成果展示與歷程記錄。

目錄:
1. [成果展示](#成果展示)
2. [歷程記錄](#歷程記錄)
   1. [資料放入 Unity](#資料放入-Unity)
   2. [Unity 中處理資料與編寫程式](#Unity-中處理資料與編寫程式)
   3. [結果呈現](#結果呈現)
3. [結論](#結論)


## 成果展示

[淹水防災模擬展示](https://youtu.be/Z4gQ6lAvIG0)

[模型細部展示](https://youtu.be/8fbdzxxWMvw)


整體模型側視

![整體模型側視](/result_pic/pic1.png)


下雨第一小時疏散路線

![疏散路線第一小時](/result_pic/pic2.png)


下雨第二小時疏散路線

![疏散路線第二小時](/result_pic/pic3.png)


專案流程圖

![流程圖](/result_pic/pic4.jpg)


## 歷程記錄

專案製作分三個步驟

1. 資料放入 Unity
2. Unity 中處理資料與編寫程式
3. 結果呈現

### 資料放入 Unity

本專案使用四個資料，分別為
1. 道路資料.shp (2D)
2. 建築資料.shp (2D，高度資料在屬性表裡)
3. 數值地形模型.tif (3D)
4. 淹水高度模型.tif (3D)


這裡有兩種格式，我分別用三種方式放入 Unity。

*第一種*，網格式檔案 GeoTIFF。把 GeoTIFF 檔匯入成 Unity 的 Terrain 元件，因為 Terrain 元件提供的 API 能容易取得高度，利於計算淹水。

Terrain 支援 RAW 檔，因此把 GeoTIFF 轉 RAW，有軟體可以使用軟體，我選擇使用 gdal 的 gdal_translate，指令如下:

```
.\gdal_translate.exe -of ENVI -ot Byte -outsize 2048 2048 -a_srs EPSG:3826 file.tif file.raw
```

可改的參數有 -ot、-outsize、-a_srs:
* -ot: 可選 Byte、Int16，差別在數值上限，和遇到空資料，兩者轉換結果不一樣。 
* -outsize: 在匯入 Unity 時會直接影響解析度設定，建議設定成 512 * 512、1024 * 1024、2048 * 2048、4096 * 4096，這幾個是 Terrain 接受的解析度，在放入 Unity 時比較不會出錯。
* -a_srs: 結果檔案的座標系統。

*第二種*，向量式資料 SHP。為了正確呈現建築形狀，我用軟體轉成 OBJ 檔，並拉伸，使其從有高度的平面變為立體。OBJ 可以直接放入 Unity。

*第三種*，道路資料。本專案目的是要找到疏散路線，使用最短路徑演算法，須建構圖 (Graph) 。因此把它轉成 GeoJSON ，有利解析點線資料，方便建構圖。

以上轉檔過程中需要注意以下幾點:
1. 檔案的座標系統要事先統一，雖然 Unity 不會直接接受檔案座標資訊，但在 Unity 設定座標時會需要該資訊。
2. Unity Terrain 支援的解析度為 512 * 512、1024 * 1024、2048 * 2048、4096 * 4096，因此在使用 gdal 指令時需要設定正確。此設定錯誤會導致 Terrain 形狀詭異。
3. 若嫌太麻煩，可以購買 GIS Terrain Loader 套件，省去轉檔。

### Unity 中處理資料與編寫程式

地理資料放入 Unity 須注意的事:
1. Unity 為左手坐標系，匯入的地形模型需水平翻轉才會是正確方向。
2. Unity 座標系統中，y 軸為高度，x、z 為2D平面，地理資料之 x, y, z 值對應到到 Unity 座標系統之 x, z, y。
3. Unity 接受任何種類的座標系統，取決於元件位置的設定。
4. 元件大小也需自行設定。

以上設定完成後，元件皆會在正確位置。接著編寫程式。

程式的核心為圖與最短路徑演算法。在網路上有很多教學資源，這裡不詳細介紹，只講幾個要注意的地方:
1. 確定道路資料的屬性要在地理資訊軟體過濾，還是要在程式中過濾。(屬性像是單行道、人行道等)
2. 特殊的屬性是否要特別處理。(單行道只能單向通行)

參考: [讀取 GeoJSON 並解析成圖，找出最短路徑](https://github.com/weermark/GeoJsonToGraph)

### 結果呈現

在 Unity 可用 Instatiate 配合 Prefab 動態生成元件。

## 結論

Unity 對地理資料的支援度低，導致在專案製作過程花了很多時間在找把資料放入 Unity 的方法，與放入後如何調整，這些稍微麻煩，因此在本文中詳細列出。從轉檔過程中可以看出，匯入的資料跟原始資料相比有一定的失真，因此還是建議購買插件幫助匯入。


有找到一篇類似應用的專案，連結放在底下，供參考:

https://image.hanspub.org/Html/3-2840092_18133.htm
